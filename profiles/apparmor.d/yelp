#------------------------------------------------------------------
#    Copyright (C) 2025 Canonical Ltd.
#
#    Author: Chrisa Oikonomou <chrisa.oikonomou@canonical.com>
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#------------------------------------------------------------------
# vim: ft=apparmor
#

abi <abi/4.0>,
include <tunables/global>

profile /usr/bin/yelp {

  include <abstractions/base>
  include <abstractions/dbus-session>
  include <abstractions/ibus>
  include <abstractions/freedesktop.org>
  include <abstractions/X>
  include <abstractions/gtk>
  include <abstractions/fonts>
  include <abstractions/WebKitWebProcess>
  include <abstractions/transmission-common>
  include <abstractions/audio>
  include <abstractions/private-files-strict>

  # the unix socket to use to connect to the display
  /tmp/.X11-unix/* rw,
  unix (connect, receive, send)
       type=stream
       peer=(addr="@/tmp/.X11-unix/X[0-9]*"),
  unix (connect, receive, send)
       type=stream
       peer=(addr="@/tmp/.ICE-unix/[0-9]*"),



  # dbus access
  dbus (send)
      bus=session
      path=/org/freedesktop/DBus
      interface=org.freedesktop.DBus
      member="Hello"
      peer=(name=org.freedesktop.DBus, label=unconfined),

  dbus (send)
      bus=system
      path=/net/hadess/PowerProfiles
      interface=org.freedesktop.DBus.Properties
      member="GetAll"
      peer=(name=:1.10, label=unconfined),

  dbus (send)
      bus=system
      path=/org/freedesktop/UPower/PowerProfiles
      interface=org.freedesktop.DBus.Properties
      member="GetAll"
      peer=(label=unconfined),

  dbus (send)
      bus=accessibility               
      path=/org/freedesktop/DBus
      interface=org.freedesktop.DBus
      member="Hello"
      peer=(name=org.freedesktop.DBus, label=unconfined),

  dbus (send)
      bus=accessibility
      path=/org/freedesktop/DBus
      interface=org.freedesktop.DBus
      member="Hello"
      peer=(name=org.freedesktop.DBus, label=unconfined),

  dbus (send)
      bus=system
      path=/org/freedesktop/NetworkManager
      interface=org.freedesktop.DBus.Properties
      member="GetAll"
      peer=(label=unconfined),

  dbus (send)
      bus=system
      path=/org/freedesktop/RealtimeKit1
      interface=org.freedesktop.DBus.Properties
      member="Get"
      peer=(label=unconfined),

  dbus (send)
      bus=system
      path=/org/freedesktop/RealtimeKit1
      interface=org.freedesktop.RealtimeKit1
      member="MakeThreadRealtimeWithPID"
      peer=(label=unconfined),

  dbus (receive)
      bus=accessibility
      path=/org/a11y/atspi/registry
      interface=org.a11y.atspi.Registry
      member="EventListenerDeregistered"
      peer=(name=:1.2, label=unconfined),

  dbus (bind)
      bus=accessibility
      name=org.gnome.Yelp.Sandboxed.WebProcess-*,


  dbus (receive)
      bus=accessibility
      path=/org/a11y/atspi/accessible/root
      interface=org.freedesktop.DBus.Properties
      member="Set"
      peer=(name=:1.2, label=unconfined),

  dbus (send)
      bus=accessibility
      path=/org/a11y/atspi/accessible/root
      interface=org.a11y.atspi.Socket
      member="Embed"
      peer=(name=org.a11y.atspi.Registry, label=unconfined),
  
  dbus (send)
      bus=accessibility
      path=/org/a11y/atspi/registry
      interface=org.a11y.atspi.Registry
      member="GetRegisteredEvents"
      peer=(name=org.a11y.atspi.Registry, label=unconfined),

  dbus (send)
      bus=accessibility
      path=/org/a11y/atspi/registry/deviceeventcontroller
      interface=org.a11y.atspi.DeviceEventController
      member="GetKeystrokeListeners"
      peer=(name=org.a11y.atspi.Registry, label=unconfined),  
 
  dbus (send)
      bus=accessibility
      path=/org/a11y/webkit/accessible/**
      interface=org.a11y.atspi.Socket
      member="Embedded"
      peer=(label=/usr/bin/yelp),

  dbus (receive)
      bus=accessibility
      path=/org/a11y/webkit/accessible/**
      interface=org.a11y.atspi.Socket
      member="Embedded"
      peer=(label=/usr/bin/yelp),

  dbus (receive)
      bus=accessibility
      path=/org/a11y/webkit/accessible/*
      interface=org.a11y.atspi.DeviceEventController
      member="Embedded"
      peer=(label=/usr/bin/yelp),

  dbus (send)
      bus=accessibility
      path=/org/a11y/atspi/registry
      interface=org.a11y.atspi.Registry
      member="GetRegisteredEvents",

  dbus (send, receive)
      bus=accessibility
      path=/org/a11y/atspi/registry
      interface=org.a11y.atspi.Registry
      member="EventListenerDeregistered",

  # file accessing 
  @{sys}/devices/**/uevent r,
  @{sys}/devices/**/vendor r,
  @{sys}/devices/**/device r,
  @{sys}/devices/**/subsystem_vendor r,
  @{sys}/devices/**/subsystem_device r,
  @{sys}/devices/**/revision r,
  @{sys}/devices/**/config r,
  @{sys}/devices/**/drm/ r,
  @{sys}/devices/virtual/dmi/id/chassis_type r,
  @{sys}/firmware/acpi/pm_profile r,
  @{sys}/fs/cgroup/user.slice/user-*.slice/user@*.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.* r,
  @{sys}/fs/cgroup/user.slice/user-*.slice/session-*.scope/memory.* r,

  owner @{run}/user/@{uid}/pulse/ r,
  @{run}/user/[0-9]*/dconf/user rw,
  @{run}/user/[0-9]*/wayland-0 rw,

  @{etc_ro}/glvnd/egl_vendor.d/ r,
    
  @{PROC}/sys/dev/i915/perf_stream_paranoid r,
  @{PROC}/zoneinfo r,
  @{PROC}/*/cgroup r,
  @{PROC}/*/comm r,
  @{PROC}/*/cmdline r,

  owner @{HOME}/.config/yelp/** rw,
  owner @{HOME}/.local/share/yelp/** rwk,
  owner @{HOME}/.cache/yelp/ r,
  owner @{HOME}/.cache/yelp/** r,
  owner @{HOME}/.cache/mesa_shader_cache_db/** rwk,
  @{HOME}/.config/dconf/user r,


  /usr/share/glvnd/egl_vendor.d/* r,
  /usr/share/glvnd/egl_vendor.d/ r,
  /usr/share/egl/egl_external_platform.d/ r,
  /usr/share/egl/egl_external_platform.d/*.json r,
  /usr/share/yelp/ rw,
  /usr/share/yelp/** rw,
  /usr/share/help/C/gnome-help/ r,
  /usr/share/help/C/gnome-help/** r,
  /usr/share/yelp-xsl/ r,
  /usr/share/yelp-xsl/** r,
  /usr/share/nvidia/nvidia-application-profiles-* r, 
  
  /var/lib/snapd/desktop/icons/ r,
 
  /dev/udmabuf rw,

  /**.html r,
  /**/**/*.html r,

  /**.xml r,
  /**/**/*.xml r,
}


