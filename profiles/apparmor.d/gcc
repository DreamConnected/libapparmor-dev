#------------------------------------------------------------------
#    Copyright (C) 2025 Canonical Ltd.
#
#    Author: Maxime BÃ©lair <maxime.belair@canonical.com>
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#------------------------------------------------------------------
# vim: ft=apparmor

abi <abi/4.0>,

include <tunables/global>

profile gcc /usr/bin/@{multiarch}-g{cc,++}-* {
  include <abstractions/base>

  # Allows reading everywhere, but disables directly writing on system files
  file /** rw,
  audit deny /{boot,cdrom,etc,proc,sys,var}/** w,

  # Binaries used by gcc (ld, as, ...)
  file /usr/bin/@{multiarch}-* ixr,
  file /usr/libexec/gcc/@{multiarch}/*/* ixr,

  # Required to allow compiling into directories owned by somebody else
  # For instance, sudo gcc into user-owned directory or sandboxed environments
  capability dac_read_search dac_override,

  # Support for alternate linkers (-fuse-ld option)
  file /usr/lib/llvm-*/bin/lld ixr,
  file /usr/bin/mold ixr,

  # Usable by -wrapper. All other binaries are denied to prevent spawning
  # arbitrary commands e.g. shells
  file /{usr/,}bin/{echo,gdb} ix,

  # Site-specific additions and overrides. See local/README for details.
  include if exists <local/gcc>
}
