# vim:syntax=apparmor

#include <tunables/global>

/usr/bin/pidgin {
  #include <abstractions/audio>
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/dbus-strict>
  #include <abstractions/dbus-session-strict>
  #include <abstractions/dbus-accessibility-strict>
  #include <abstractions/enchant>
  #include <abstractions/gnome>
  #include <abstractions/ibus>
  #include <abstractions/launchpad-integration>
  #include <abstractions/nameservice>
  #include <abstractions/private-files-strict>
  #include <abstractions/ssl_certs>
  #include <abstractions/ubuntu-browsers>
  #include <abstractions/ubuntu-helpers>
  #include <abstractions/user-download>
  #include <abstractions/ubuntu-unity7-base>
  #include <abstractions/ubuntu-unity7-launcher>
  #include <abstractions/ubuntu-unity7-messaging>

  deny capability sys_ptrace,
  deny @{HOME}/.local/share/applications/wine/ r,

  dbus (receive, send)
       bus=accessibility
       peer=(label=unconfined),

  # pidgin provides a dbus service
  dbus (send)
       bus=session
       interface=org.freedesktop.DBus
       member=RequestName,
  dbus (send)
       bus=session
       interface=org.freedesktop.DBus
       member=ReleaseName,
  dbus (bind)
       bus=session
       name=im.pidgin.purple.PurpleService,
  dbus (send, receive)
       bus=session
       peer=(name=im.pidgin.purple.PurpleService),
  dbus (send, receive)
       bus=session
       peer=(label=/usr/bin/pidgin),
  dbus (send)
       bus=session
       path=/im/pidgin/purple/**
       peer=(name=org.freedesktop.DBus,label=unconfined),

  # gnome dbus accesses (gconf)
  dbus (send)
       bus=session
       path=/org/gnome/GConf/Server
       member=GetDefaultDatabase
       peer=(label=unconfined),
  dbus (send)
       bus=session
       path=/org/gnome/GConf/Database/*
       member={AddMatch,AddNotify,AllDirs,AllEntries,LookupExtended,RemoveNotify}
       peer=(label=unconfined),

  # gnome DBus accesses
  dbus (send, receive)
       bus=session
       interface=org.gtk.vfs.MountTracker,
  dbus (send)
       bus=session
       path="/org/gtk/vfs/mount/*"
       interface=org.gtk.vfs.Mount,
  dbus (send)
       bus=session
       interface="org.gtk.vfs.Daemon",
  dbus (receive, send)
       bus=session
       interface=org.gtk.Private.RemoteVolumeMonitor,


  owner @{HOME}/.purple/ rw,
  owner @{HOME}/.purple/** rwk,
  owner @{HOME}/.{cache,config}/dconf/user rw,
  owner @{HOME}/.config/indicators/ rw,
  owner @{HOME}/.config/indicators/** rw,
  owner @{HOME}/.local/share/applications/ r,
  owner /{,var/}run/user/[0-9]*/dconf/user rwk,

  /bin/dash rix,
  /bin/which rix,

  # NB: the preferred browser and proxy settings must be configured
  # in the GNOME preferences: this profile does not allow running
  # the corresponding external configuration applications.
  /usr/bin/gconftool-2 rPix,
  /usr/bin/gnome-open rmix,
  /usr/bin/gsettings rix,
  /usr/bin/gvfs-open rmix,
  /usr/bin/pidgin r,
  /usr/bin/xdg-open rmix,

  /etc/purple/prefs.xml r,

  /usr/share/gnome/applications/ r,
  /usr/share/glib-2.0/schemas/gschemas.compiled r,

  /usr/lib/frei0r-1/*.so rm,
  /usr/lib/@{multiarch}/libvisual-*/**.so rm,
  /usr/lib/pidgin/*.so rm,
  /usr/lib/purple*/*.so rm,

  # pidgin-blinklight plugin
  /usr/lib/pidgin-blinklight/blinklight-fixperm rPix,
  @{PROC}/acpi/ibm/light rwk,

  /usr/share/purple/ca-certs/ r,
  /usr/share/purple/ca-certs/** r,
  /usr/share/tcltk/** r,
  /usr/share/themes/ r,

  owner @{PROC}/[0-9]*/auxv r,
  owner @{PROC}/[0-9]*/fd/ r,

# jamie - additions over apparmor-profiles
owner @{HOME}/.face r,
deny ptrace peer=unconfined,

# gstreamer abstraction?
owner @{HOME}/.gstreamer*/ rw,
owner @{HOME}/.gstreamer*/** rw,
owner @{HOME}/.cache/gstreamer-1.0/registry*bin* rw,
/usr/lib/@{multiarch}/gstreamer1.0/gstreamer-1.0/gst-plugin-scanner rix,
/sys/devices/system/node/ r,
/sys/devices/system/cpu/ r,
/sys/bus/ r,
/sys/class/ r,
/dev/ r,
/dev/dri/ r,
/sys/class/drm/ r,
/sys/devices/pci[0-9a-f]**/drm/** r,

deny /usr/share/ubuntu/applications/ r,
deny /var/lib/snapd/desktop/applications/ r,
deny /run/user/[0-9]*/at-spi2-*/ w,

dbus (receive, send)
    bus=system
    path="/org/freedesktop/NetworkManager"
    interface="org.freedesktop.NetworkManager"
    member={state,PropertiesChanged}
    peer=(label=unconfined),

dbus (receive)
    bus=system
    path="/org/freedesktop/NetworkManager"
    interface="org.freedesktop.NetworkManager"
    member={CheckPermissions,DeviceAdded,DeviceRemoved,StateChanged}
    peer=(label=unconfined),
}
