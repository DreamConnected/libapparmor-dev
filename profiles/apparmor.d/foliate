#------------------------------------------------------------------
#    Copyright (C) 2024 Canonical Ltd.
#
#    Author: Federico Quattrin <federico.quattrin@canonical.com>
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#------------------------------------------------------------------
# vim: ft=apparmor
#

abi <abi/4.0>,

include <tunables/global>


profile foliate /usr/bin/foliate flags=(enforce) {
  include <abstractions/base>
  include <abstractions/dbus-session-strict>
  include <abstractions/ubuntu-browsers.d/plugins-common>
  include <abstractions/ubuntu-browsers.d/ubuntu-integration>
  include <abstractions/mesa>
  include <abstractions/private-files-strict>

  signal send set=kill peer=foliate//bwrap,

  userns,

  network netlink,

  unix (send receive) addr=none peer=(label=foliate//WebKitNetworkProcess),
  unix (send receive) type=seqpacket addr=none peer=(label="foliate//bwrap"),
  unix (send receive) type=seqpacket addr=none peer=(label="foliate//WebKitWebProcess"),

  dbus (send) bus="accessibility" path="/org/a11y/atspi/accessible/root" interface="org.a11y.atspi.Socket" member=Embed peer=(label="unconfined"),
  dbus (send) bus="accessibility" path=/org/a11y/webkit/accessible/* interface="org.a11y.atspi.Socket" member=Embedded peer=(label="foliate//bwrap//&foliate//xdg-dbus-proxy"),
  dbus (receive) bus="accessibility" path="/org/a11y/atspi/accessible/root" interface="org.freedesktop.DBus.Properties" member=Set peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/a11y/bus" interface="org.a11y.Bus" member="GetAddress" peer=(label="unconfined"),

  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.portal.FileChooser" member={OpenFile,SaveFile} peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.portal.OpenURI" member="OpenFile" peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.portal.Settings" member="Read" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/org/freedesktop/portal/desktop/request/*/gtk*" interface="org.freedesktop.portal.Request" member="Response" peer=(label="unconfined"),

  dbus (send) bus="session" path="/org/gtk/Private/RemoteVolumeMonitor" interface="org.gtk.Private.RemoteVolumeMonitor" member={IsSupported,List} peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/gtk/vfs/Daemon" interface="org.gtk.vfs.Daemon" member={GetConnection,ListMonitorImplementations} peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/gtk/vfs/metadata" interface="org.gtk.vfs.Metadata" member="Remove" peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/gtk/vfs/mounttracker" interface="org.gtk.vfs.MountTracker" member={ListMounts2,LookupMount,ListMountableInfo} peer=(label="unconfined"),
  dbus (receive) bus="session" path="/org/gtk/vfs/mounttracker" interface="org.gtk.vfs.MountTracker" member="Mounted" peer=(label="unconfined"),

  dbus (send) bus="accessibility" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member=Hello peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={ReleaseName,RequestName} peer=(label="unconfined"),
  dbus (send) bus="system" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={StartServiceByName,AddMatch,GetNameOwner,Hello,RemoveMatch} peer=(label=unconfined),
  dbus (send) bus="system" path="/org/freedesktop/hostname1" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),

  dbus (send) bus="session" path="/ca/desrt/dconf/Writer/user" interface="ca.desrt.dconf.Writer" member="Change" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/ca/desrt/dconf/Writer/user" interface="ca.desrt.dconf.Writer" member="Notify" peer=(label="unconfined"),

  dbus (bind) bus="session" name="com.github.johnfactotum.Foliate",
  dbus (send) bus="session" path="/com/github/johnfactotum/Foliate/window/*" interface="org.gtk.Actions" member="Changed" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/com/github/johnfactotum/Foliate/window/*" interface="org.gtk.Actions" member="DescribeAll" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member="DescribeAll" peer=(label="unconfined"),
  dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member={DescribeAll,Open} peer=(label="foliate"),
  dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Application" member=Open peer=(label="foliate"),

  # Access to ebooks
  owner @{HOME}/[^.]**.[eE][pP][uU][bB] r,
  owner @{HOME}/[^.]**.[mM][oO][bB][iI] r,
  owner @{HOME}/[^.]**.[aA][zZ][wW] r,
  owner @{HOME}/[^.]**.[kK][fF][xX] r,
  owner @{HOME}/[^.]**.[aA][zZ][wW]3 r,
  owner @{HOME}/[^.]**.[fF][bB][23] r,
  owner @{HOME}/[^.]**.[cC][bB][rR] r,
  owner @{HOME}/[^.]**.[cC][bB][zZ] r,
  owner @{HOME}/[^.]**.[pP][nN][gG] r,
  owner @{HOME}/[^.]**.[jJ][pP][eE][gG] r,
  owner @{HOME}/[^.]**.[jJ][pP][gG] r,
  owner @{HOME}/.local/share/gvfs-metadata/home/{**,} r,
  owner @{HOME}/.local/share/com.github.johnfactotum.Foliate/{**,} rw,

  @{PROC}/zoneinfo r,
  @{run}/dbus/system_bus_socket rw,
  @{sys}/devices/pci**/device r,
  @{sys}/devices/pci**/subsystem_device r,
  @{sys}/devices/pci**/subsystem_vendor r,
  @{sys}/devices/pci**/uevent r,
  @{sys}/devices/pci**/vendor r,
  @{sys}/devices/virtual/dmi/id/chassis_type r,
  @{sys}/firmware/acpi/pm_profile r,
  @{etc_ro}/ld.so.cache r,
  @{etc_ro}/nsswitch.conf r,
  @{etc_ro}/passwd r,
  @{etc_ro}/glvnd/{**,} r,
  @{etc_ro}/vulkan/{**,} r,
  /var/lib/snapd/desktop/icons/ r,
  /usr/share/** r,
  /usr/bin/bwrap Cx -> bwrap,
  /usr/bin/foliate r,
  /usr/bin/speech-dispatcher Cx -> speech-dispatcher,
  /usr/lib/*/webkitgtk-*/WebKitNetworkProcess Cx -> WebKitNetworkProcess,

  owner @{HOME}/.cache/com.github.johnfactotum.Foliate/** rwkl,
  owner @{HOME}/.config/dconf/user r,
  owner @{PROC}/@{pid}/cgroup r,
  owner @{PROC}/@{pid}/cmdline r,
  owner @{PROC}/@{pid}/mounts r,
  owner @{PROC}/@{pid}/stat r,
  owner @{PROC}/@{pid}/statm r,
  owner @{PROC}/@{pid}/task/@{pid}/stat r,
  owner @{run}/user/@{uid}/.flatpak/ w,
  owner @{run}/user/@{uid}/.flatpak/webkit-*/{,bwrapinfo.json} rw,
  owner @{run}/user/@{uid}/.mutter-Xwaylandauth.* r,
  owner @{run}/user/@{uid}/gvfsd/socket-* rw,
  owner @{run}/user/@{uid}/speech-dispatcher/speechd.sock rw,
  owner @{run}/user/@{uid}/wayland-0 rw,
  owner @{run}/user/@{uid}/webkitgtk/{**,} rw,
  owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
  owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
  owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,

  profile bwrap flags=(attach_disconnected.path=/container/, attach_disconnected) {
    include <abstractions/base>
    include <abstractions/consoles>
    include <abstractions/ubuntu-konsole>
    include <abstractions/dbus-session>
    include <abstractions/mesa>
    include <abstractions/WebKitWebProcess>
    include <abstractions/nameservice-strict>

    signal receive set=kill peer=foliate,
    userns create,
    network netlink,
    
    unix (send receive) type=seqpacket addr=none peer=(label="foliate"),
    unix (send receive) type=seqpacket addr=none peer=(label="foliate//WebKitNetworkProcess"),
    
    dbus (send) bus="accessibility" path="/" interface="org.freedesktop.DBus" member={AddMatch,GetNameOwner} peer=(label="unconfined"),
    dbus (send receive) bus="accessibility" path="/org/a11y/webkit/accessible/*" interface="org.a11y.atspi.Socket" member="Embedded" peer=(label="foliate"),
    
    dbus (send) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="GetRegisteredEvents" peer=(label="unconfined"),
    dbus (receive) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="EventListenerDeregistered" peer=(label="unconfined"),    
    dbus (send) bus="accessibility" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={Hello,AddMatch,GetNameOwner,StartServiceByName,RemoveMatch} peer=(label="unconfined"),
    
    dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member={DescribeAll,Open} peer=(label="foliate"),

    capability setpcap,
    capability sys_admin,
    capability net_admin,
    capability net_bind_service,
    capability dac_override,
    capability dac_read_search,

    mount options in (rw, silent, rslave, rbind, ro, nosuid, nodev, remount, bind, silent, relatime, noexec, rprivate),
    mount fstype=tmpfs options=(rw, nosuid, nodev),
    mount fstype=devpts options in (rw, nosuid, noexec),
    mount fstype=proc options in (rw, nosuid, nodev, noexec),
    umount,

    pivot_root /tmp/,
    pivot_root /newroot/,
    /newroot/** rw,

    /container/** rw,
    /bindfile** rw,
    owner / r,


    /apparmor/.null rw,
    @{PROC}/sys/kernel/overflowgid r,
    @{PROC}/sys/kernel/overflowuid r,
    @{PROC}/zoneinfo r,
    @{PROC}/@{pid}/mountinfo r,
    @{run}/user/@{uid}/webkitgtk/bus-proxy-* rw,
    @{run}/user/@{uid}/webkitgtk/a11y-proxy-** rw,
    /usr/bin/bwrap mr,
    /usr/bin/xdg-dbus-proxy Px -> foliate//bwrap//&foliate//xdg-dbus-proxy,
    /usr/lib/@{multiarch}/webkitgtk-*/WebKitWebProcess Px -> foliate//bwrap//&foliate//WebKitWebProcess,
    
    owner @{PROC}/@{pid}/fd/ r,
    owner @{run}/user/@{uid}/.flatpak/** rw,
    owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
    owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
    owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,
    owner @{PROC}/@{pid}/uid_map rw,
    owner @{PROC}/@{pid}/cgroup r,
    owner @{PROC}/@{pid}/cmdline r,
    owner @{PROC}/@{pid}/mounts r,
    owner @{PROC}/@{pid}/stat r,
    owner @{PROC}/@{pid}/setgroups rw,
    owner @{PROC}/@{pid}/gid_map rw,

    include if exists <local/foliate_bwrap>
  }

  profile WebKitWebProcess flags=(attach_disconnected.path=/container/, attach_disconnected){
    include <abstractions/X>
    include <abstractions/fonts>
    include <abstractions/mesa>
    include <abstractions/base>
    include <abstractions/WebKitWebProcess>

    network unix,

    /container/apparmor/.null rw,
    /container/dev/null r,
    /container/dev/urandom r,
    /container/@{HOME}/.cache/com.github.johnfactotum.Foliate/** rw,
    /container/@{HOME}/.local/share/gvfs-metadata/home/{**,} r,
    /container/proc/meminfo r,
    /container/proc/zoneinfo r,
    /container/proc/*/cgroup r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
    /container/@{run}/user/@{uid}/wayland-* rw,
    /container/@{run}/user/@{uid}/webkitgtk/a11y-proxy-* rw,
    
    
    /dev/dri/ r,
    /dev/urandom r,
    
    @{etc_ro}/nsswitch.conf r,
    @{etc_ro}/passwd r,
    @{etc_ro}/locale.alias r,
    
    /usr/bin/xdg-dbus-proxy mr,
    /usr/share/drirc.d/ r,
    /usr/share/drirc.d/*.conf r,
    /usr/share/icons/{**,} r,
    /usr/share/glib-*/schemas/gschemas.compiled r,
    /usr/share/mime/mime.cache r,
    /usr/share/pixmaps/ r,
    /usr/share/poppler/cMap/** r,
    /usr/share/zoneinfo/{**,} r,
    
    /usr/lib/locale/locale-archive r,

    @{sys}/devices/system/cpu/online r,
    @{sys}/devices/system/cpu/possible r,
    
    owner @{run}/user/@{uid}/webkitgtk/bus-proxy-* rw,
    owner @{run}/user/@{uid}/webkitgtk/** rw,

    include if exists <local/foliate_WebKitWebProcess>
}

  profile xdg-dbus-proxy flags=(attach_disconnected.path=/container/, attach_disconnected){
    include <abstractions/base>
    network unix,

    dbus (send) bus="accessibility" path="/" interface="org.freedesktop.DBus" member={AddMatch,GetNameOwner} peer=(label="unconfined"),
    dbus (receive) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="EventListenerDeregistered" peer=(label="unconfined"),
    dbus (send) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="GetRegisteredEvents" peer=(label="unconfined"),
    dbus (receive) bus="accessibility" path="/org/a11y/webkit/accessible/*" interface="org.a11y.atspi.Socket" member="Embedded" peer=(label="foliate"),
    dbus (send) bus="accessibility" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={Hello,AddMatch,GetNameOwner,StartServiceByName,RemoveMatch} peer=(label="unconfined"),
    
    /container/dev/null r,
    /container/dev/urandom r,
    /container/proc/zoneinfo r,
    /container/proc/meminfo r,
    /container/proc/*/cgroup r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
    /container/@{run}/user/@{uid}/.flatpak/webkit-*/bwrapinfo.json rw,
    /container/@{run}/user/@{uid}/at-spi/bus rw,

    @{etc_ro}/ld.so.cache r,
    @{etc_ro}/locale.alias r,

    @{PROC}/filesystems r,
    @{run}/user/@{uid}/webkitgtk/bus-proxy-* rw,
    @{run}/user/@{uid}/webkitgtk/** rw,
    
    /usr/lib/locale/locale-archive r,
    /usr/bin/xdg-dbus-proxy mr,
    
    include if exists <local/foliate_xdg-dbus-proxy>
  }

  profile speech-dispatcher /usr/bin/speech-dispatcher flags=(enforce) {
    include <abstractions/audio>
    include <abstractions/base>
    include <abstractions/consoles>
    include <abstractions/dbus-session-strict>

    @{etc_ro}/speech-dispatcher/** r,
    @{PROC}/sys/vm/overcommit_memory r,
    /usr/bin/speech-dispatcher mr,
    owner @{HOME}/.config/pulse/cookie rk,
    owner @{run}/user/@{uid}/ r,
    owner @{run}/user/@{uid}/pulse/ r,
    owner @{run}/user/@{uid}/pulse/native rw,
    owner @{run}/user/@{uid}/speech-dispatcher/** rwk,

    include if exists <local/foliate_speech-dispatcher>
  }

  profile WebKitNetworkProcess /usr/lib/@{multiarch}/webkitgtk-*/WebKitNetworkProcess flags=(enforce) {
    include <abstractions/base>
    include <abstractions/dbus-session>
    include <abstractions/nameservice>
    include <abstractions/ubuntu-browsers.d/ubuntu-integration>

    unix (send receive) type=seqpacket addr=none peer=(label="foliate"),
    unix (send receive) type=seqpacket addr=none peer=(label="foliate//bwrap"),
    unix (send receive) type=seqpacket addr=none peer=(label="foliate//WebKitWebProcess"),
    
    dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member={DescribeAll,Open} peer=(label="foliate"),
    
    dbus (send) bus="system" path="/net/hadess/PowerProfiles" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
    
    dbus (receive) bus="system" path="/org/freedesktop/NetworkManager" interface="org.freedesktop.DBus.Properties" member="PropertiesChanged" peer=(label="unconfined"),
    dbus (receive) bus="system" path="/org/freedesktop/NetworkManager" interface="org.freedesktop.NetworkManager" member="StateChanged" peer=(label="unconfined"),
    dbus (send) bus="system" path="/org/freedesktop/NetworkManager" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
    
    
    /apparmor/.null rw,
    # Access to ebooks
    owner @{HOME}/[^.]**.[eE][pP][uU][bB]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[mM][oO][bB][iI]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[aA][zZ][wW]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[kK][fF][xX]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[aA][zZ][wW]3{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[fF][bB][23]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[cC][bB][rR]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[cC][bB][zZ]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[pP][nN][gG]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[jJ][pP][eE][gG]{.wkdownload,} rw,
    owner @{HOME}/[^.]**.[jJ][pP][gG]{.wkdownload,} rw,

    owner @{HOME}/.goutputstream-* rw,
    
    @{PROC}/@{pid}/cgroup r,
    @{PROC}/zoneinfo r,
    @{run}/dbus/system_bus_socket rw,
    @{sys}/devices/system/cpu/online r,
    @{sys}/fs/cgroup/**/memory.current r,
    @{sys}/fs/cgroup/**/memory.max r,
    @{sys}/fs/cgroup/**/memory.high r,
    /usr/lib/*/webkitgtk-*/WebKitNetworkProcess mr,
    /usr/share/publicsuffix/public_suffix_list.dafsa r,
    
    owner @{PROC}/@{pid}/maps r,
    owner @{run}/user/@{uid}/bus rw,
    owner @{HOME}/.cache/com.github.johnfactotum.Foliate/** rwlk,
    owner @{HOME}/.local/share/com.github.johnfactotum.Foliate/** rw,
    owner @{HOME}/.config/dconf/user r,

    include if exists <local/foliate_WebKitNetworkProcess>
  }

  include if exists <local/foliate>
}
