#------------------------------------------------------------------
#    Copyright (C) 2024 Canonical Ltd.
#
#    Author: Federico Quattrin <federico.quattrin@canonical.com>
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#------------------------------------------------------------------
# vim: ft=apparmor
#

abi <abi/4.0>,

include <tunables/global>


profile foliate /usr/bin/foliate flags=(enforce) {
  include <abstractions/base>
  include <abstractions/dbus-session-strict>
  include <abstractions/ubuntu-browsers.d/plugins-common>
  include <abstractions/ubuntu-browsers.d/ubuntu-integration>
  include <abstractions/mesa>
  include <abstractions/private-files-strict>

  signal send set=kill peer=foliate///usr/bin/bwrap,

  userns,

  network netlink,

  unix (send, receive) addr=none peer=(label=foliate//WebKitNetworkProcess),
  unix (send receive) type=seqpacket addr=none peer=(label="foliate///usr/bin/bwrap"),
  unix (send receive) type=seqpacket addr=none peer=(label="foliate//WebKitWebProcess"),

  dbus (send) bus="accessibility" path="/org/a11y/atspi/accessible/root" interface="org.a11y.atspi.Socket" member=Embed peer=(label="unconfined"),
  dbus (send) bus="accessibility" path=/org/a11y/webkit/accessible/* interface="org.a11y.atspi.Socket" member=Embedded peer=(label="foliate///usr/bin/bwrap//&foliate//xdg-dbus-proxy"),
  dbus (receive) bus="accessibility" path="/org/a11y/atspi/accessible/root" interface="org.freedesktop.DBus.Properties" member=Set peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/a11y/bus" interface="org.a11y.Bus" member="GetAddress" peer=(label="unconfined"),

  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.portal.FileChooser" member={OpenFile,SaveFile} peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.portal.OpenURI" member="OpenFile" peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/portal/desktop" interface="org.freedesktop.portal.Settings" member="Read" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/org/freedesktop/portal/desktop/request/*/gtk*" interface="org.freedesktop.portal.Request" member="Response" peer=(label="unconfined"),

  dbus (send) bus="session" path="/org/gtk/Private/RemoteVolumeMonitor" interface="org.gtk.Private.RemoteVolumeMonitor" member={IsSupported,List} peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/gtk/vfs/Daemon" interface="org.gtk.vfs.Daemon" member={GetConnection,ListMonitorImplementations} peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/gtk/vfs/metadata" interface="org.gtk.vfs.Metadata" member="Remove" peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/gtk/vfs/mounttracker" interface="org.gtk.vfs.MountTracker" member={ListMounts2,LookupMount,ListMountableInfo} peer=(label="unconfined"),
  dbus (receive) bus="session" path="/org/gtk/vfs/mounttracker" interface="org.gtk.vfs.MountTracker" member="Mounted" peer=(label="unconfined"),

  dbus (send) bus="accessibility" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member=Hello peer=(label="unconfined"),
  dbus (send) bus="session" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={ReleaseName,RequestName} peer=(label="unconfined"),
  dbus (send) bus="system" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={StartServiceByName,AddMatch,GetNameOwner,Hello,RemoveMatch} peer=(label=unconfined),
  dbus (send) bus="system" path="/org/freedesktop/hostname1" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),

  dbus (send) bus="session" path="/ca/desrt/dconf/Writer/user" interface="ca.desrt.dconf.Writer" member="Change" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/ca/desrt/dconf/Writer/user" interface="ca.desrt.dconf.Writer" member="Notify" peer=(label="unconfined"),

  dbus (bind) bus="session" name="com.github.johnfactotum.Foliate",
  dbus (send) bus="session" path="/com/github/johnfactotum/Foliate/window/*" interface="org.gtk.Actions" member="Changed" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/com/github/johnfactotum/Foliate/window/*" interface="org.gtk.Actions" member="DescribeAll" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
  dbus (receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member="DescribeAll" peer=(label="unconfined"),
  dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member={DescribeAll,Open} peer=(label="foliate"),
  dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Application" member=Open peer=(label="foliate"),

  # Access to ebooks
  @{HOME}/**.[eE][pP][uU][bB] r,
  @{HOME}/**.[mM][oO][bB][iI] r,
  @{HOME}/**.[aA][zZ][wW] r,
  @{HOME}/**.[kK][fF][xX] r,
  @{HOME}/**.[aA][zZ][wW]3 r,
  @{HOME}/**.[fF][bB][23] r,
  @{HOME}/**.[cC][bB][rR] r,
  @{HOME}/**.[cC][bB][zZ] r,
  @{HOME}/**.[pP][nN][gG] r,
  @{HOME}/**.[jJ][pP][eE][gG] r,
  @{HOME}/**.[jJ][pP][gG] r,
  @{HOME}/.local/share/gvfs-metadata/home/{**,} r,
  @{HOME}/.local/share/com.github.johnfactotum.Foliate/{**,} rw,

  @{PROC}/zoneinfo r,
  @{run}/dbus/system_bus_socket rw,
  @{sys}/devices/pci**/device r,
  @{sys}/devices/pci**/subsystem_device r,
  @{sys}/devices/pci**/subsystem_vendor r,
  @{sys}/devices/pci**/uevent r,
  @{sys}/devices/pci**/vendor r,
  @{sys}/devices/virtual/dmi/id/chassis_type r,
  @{sys}/firmware/acpi/pm_profile r,
  @{etc_ro}/ld.so.cache r,
  @{etc_ro}/nsswitch.conf r,
  @{etc_ro}/passwd r,
  @{etc_ro}/glvnd/{**,} r,
  @{etc_ro}/vulkan/{**,} r,
  /var/lib/snapd/desktop/icons/ r,
  /usr/share/** r,
  /usr/bin/bwrap Cx,
  /usr/bin/foliate r,
  /usr/bin/speech-dispatcher Cx -> speech-dispatcher,
  /usr/lib/*/webkitgtk-*/WebKitNetworkProcess Cx -> WebKitNetworkProcess,

  owner @{HOME}/.cache/com.github.johnfactotum.Foliate/** rwkl,
  owner @{HOME}/.config/dconf/user r,
  owner @{PROC}/*/cgroup r,
  owner @{PROC}/*/cmdline r,
  owner @{PROC}/*/mounts r,
  owner @{PROC}/*/stat r,
  owner @{PROC}/*/statm r,
  owner @{PROC}/*/task/*/stat r,
  owner @{run}/user/@{uid}/.flatpak/ w,
  owner @{run}/user/@{uid}/.flatpak/webkit-*/{,bwrapinfo.json} rw,
  owner @{run}/user/@{uid}/.mutter-Xwaylandauth.* r,
  owner @{run}/user/@{uid}/gvfsd/socket-* rw,
  owner @{run}/user/@{uid}/speech-dispatcher/speechd.sock rw,
  owner @{run}/user/@{uid}/wayland-0 rw,
  owner @{run}/user/@{uid}/webkitgtk/{**,} rw,
  owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
  owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
  owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,

  profile /usr/bin/bwrap flags=(attach_disconnected.path=/container/, attach_disconnected) {
    include <abstractions/base>
    include <abstractions/consoles>
    include <abstractions/ubuntu-konsole>
    include <abstractions/dbus-session>
    include <abstractions/mesa>
    
    signal receive set=kill peer=foliate,
    userns create,
    network netlink,
    
    unix (send receive) type=seqpacket addr=none peer=(label="foliate"),
    unix (send receive) type=seqpacket addr=none peer=(label="foliate//WebKitNetworkProcess"),
    
    dbus (send) bus="accessibility" path="/" interface="org.freedesktop.DBus" member={AddMatch,GetNameOwner} peer=(label="unconfined"),
    dbus (send receive) bus="accessibility" path="/org/a11y/webkit/accessible/*" interface="org.a11y.atspi.Socket" member="Embedded" peer=(label="foliate"),
    
    dbus (send) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="GetRegisteredEvents" peer=(label="unconfined"),
    dbus (receive) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="EventListenerDeregistered" peer=(label="unconfined"),    
    dbus (send) bus="accessibility" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={Hello,AddMatch,GetNameOwner,StartServiceByName,RemoveMatch} peer=(label="unconfined"),
    
    dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member={DescribeAll,Open} peer=(label="foliate"),

    capability setpcap,
    capability sys_admin,
    capability net_admin,
    capability net_bind_service,
    capability dac_override,
    capability dac_read_search,

    mount options in (rw, silent, rslave, rbind, ro, nosuid, nodev, remount, bind, silent, relatime, noexec, rprivate),
    mount fstype=tmpfs options=(rw, nosuid, nodev),
    mount fstype=devpts options in (rw, nosuid, noexec),
    mount fstype=proc options in (rw, nosuid, nodev, noexec),
    umount,

    pivot_root /tmp/,
    pivot_root /newroot/,
    /newroot/** rw,

    /container/** rw,
    /bindfile** rw,
    /{**,} r,
    
    /apparmor/.null rw,
    @{HOME}/.config/glib-*/settings/ rw,
    @{HOME}/.config/glib-*/ rw,
    @{etc_ro}/ld.so.cache r,
    @{PROC}/filesystems r,
    @{PROC}/sys/kernel/overflowgid r,
    @{PROC}/sys/kernel/overflowuid r,
    @{PROC}/zoneinfo r,
    @{PROC}/@{pid}/mountinfo r,
    @{run}/user/@{uid}/webkitgtk/bus-proxy-* rw,
    @{run}/user/@{uid}/webkitgtk/a11y-proxy-** rw,
    /usr/bin/bwrap mr,
    /usr/bin/xdg-dbus-proxy Px -> foliate///usr/bin/bwrap//&foliate//xdg-dbus-proxy,
    /usr/lib/@{multiarch}/webkitgtk-*/WebKitWebProcess Px -> foliate///usr/bin/bwrap//&foliate//WebKitWebProcess,
    
    owner @{PROC}/*/fd/ r,
    owner @{run}/user/@{uid}/.flatpak/** rw,
    owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
    owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
    owner @{sys}/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,
    owner @{PROC}/@{pid}/uid_map rw,
    owner @{PROC}/*/cgroup r,
    owner @{PROC}/*/cmdline r,
    owner @{PROC}/*/mounts r,
    owner @{PROC}/*/stat r,
    owner @{PROC}/*/statm r,
    owner @{PROC}/*/setgroups rw,
    owner @{PROC}/@{pid}/gid_map rw,

    include if exists <local/foliate_bwrap>
  }

  profile WebKitWebProcess flags=(attach_disconnected.path=/container/, attach_disconnected){
    include <abstractions/X>
    include <abstractions/fonts>
    include <abstractions/mesa>

   network unix,

    /container/apparmor/.null rw,
    /container/dev/null r,
    /container/dev/urandom r,
    /container/@{HOME}/.cache/com.github.johnfactotum.Foliate/** rw,
    /container/@{HOME}/.local/share/gvfs-metadata/home/{**,} r,
    /container/proc/meminfo r,
    /container/proc/zoneinfo r,
    /container/proc/*/cgroup r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
    /container/@{run}/user/@{uid}/wayland-* rw,
    /container/@{run}/user/@{uid}/webkitgtk/a11y-proxy-* rw,
    
    
    /dev/dri/ r,
    /dev/urandom r,
    
    @{etc_ro}/nsswitch.conf r,
    @{etc_ro}/passwd r,
    @{etc_ro}/ld.so.cache r,
    @{etc_ro}/locale.alias r,
    @{etc_ro}/glvnd/egl_vendor.d/ r,
    /.flatpak-info r,
    
    @{HOME}/.config/glib-*/ rw,
    @{HOME}/.config/glib-*/settings/ rw,

    
    @{usr}/bin/xdg-dbus-proxy mr,
    @{usr}/share/drirc.d/ r,
    @{usr}/share/drirc.d/*.conf r,
    @{usr}/share/icons/{**,} r,
    @{usr}/share/glib-*/schemas/gschemas.compiled r,
    @{usr}/share/glvnd/egl_vendor.d/ r,
    @{usr}/share/glvnd/egl_vendor.d/50_mesa.json r,
    @{usr}/share/mime/mime.cache r,
    @{usr}/share/pixmaps/ r,
    @{usr}/share/poppler/cMap/** r,
    @{usr}/share/publicsuffix/public_suffix_list.dafsa r,
    @{usr}/share/themes/Yaru/gtk-*/gtk.gresource r,
    @{usr}/share/themes/Yaru/gtk-*/gtk.css r,
    @{usr}/share/zoneinfo/{**,} r,
    
    @{usr}/lib/locale/locale-archive r,
    @{usr}/lib/@{multiarch}/gconv/gconv-modules.cache r,
    @{usr}/lib/@{multiarch}/gtk-*/*/printbackends/ r,
    @{usr}/lib/@{multiarch}/gtk-*/*/printbackends/giomodule.cache r,
    @{usr}/lib/@{multiarch}/gtk-*/*/immodules/ r,
    @{usr}/lib/@{multiarch}/gtk-*/*/immodules/libim-ibus.so r,
    @{usr}/lib/@{multiarch}/gtk-*/*/immodules/libim-ibus.so mr,
    @{usr}/lib/@{multiarch}/gtk-*/*/media/ r,
    @{usr}/lib/@{multiarch}/gtk-*/*/media/libmedia-gstreamer.so mr,
    @{usr}/lib/@{multiarch}/gio/modules/ r,
    @{usr}/lib/@{multiarch}/gio/modules/giomodule.cache r,
    @{usr}/lib/@{multiarch}/gio/modules/libdconfsettings.so mr,
    @{usr}/lib/@{multiarch}/dri/swrast_dri.so mr,
    @{usr}/lib/@{multiarch}/gdk-pixbuf-*/*/loaders.cache r,
    @{usr}/lib/@{multiarch}/webkitgtk-*/injected-bundle/libwebkitgtkinjectedbundle.so mr,
    @{usr}/lib/@{multiarch}/webkitgtk-*/WebKitWebProcess r,

    @{PROC}/2/statm r,
    @{PROC}/filesystems r,
    @{PROC}/@{pid}/maps r,
    @{PROC}/@{pid}/smaps r,
    
    @{sys}/devices/pci**/uevent r,
    @{sys}/devices/pci**/vendor r,
    @{sys}/devices/pci**/device r,
    @{sys}/devices/pci**/subsystem_vendor r,
    @{sys}/devices/pci**/subsystem_device r,
    @{sys}/devices/system/cpu/online r,
    @{sys}/devices/system/cpu/possible r,
    @{sys}/devices/virtual/dmi/id/chassis_type r,
    
    owner @{run}/user/@{uid}/webkitgtk/bus-proxy-* rw,
    owner @{run}/user/@{uid}/webkitgtk/** rw,
    
    
    
    /lib/@{multiarch}/libEGL_mesa.so.* mr,
    /lib/@{multiarch}/libglapi.so.* mr,
    /lib/@{multiarch}/ld-linux-*.so.* r,
    /lib/@{multiarch}/libglib-*.so.* mr,
    /lib/@{multiarch}/libgio-*.so.*  mr,
    /lib/@{multiarch}/libgobject-*.so.* mr,
    /lib/@{multiarch}/libc.so.* mr,
    /lib/@{multiarch}/libm.so.* mr,
    /lib/@{multiarch}/libpcre*.so.* mr,
    /lib/@{multiarch}/libgmodule-*.so.* mr,
    /lib/@{multiarch}/libz.so.* mr,
    /lib/@{multiarch}/libmount.so.* mr,
    /lib/@{multiarch}/libselinux.so.* mr,
    /lib/@{multiarch}/libffi.so.* mr,
    /lib/@{multiarch}/libblkid.so.* mr,
    /lib/@{multiarch}/libwebkitgtk-*.so.* mr,
    /lib/@{multiarch}/libepoxy.so.* mr,
    /lib/@{multiarch}/libjavascriptcoregtk-*.so.* mr,
    /lib/@{multiarch}/libicui18n.so.* mr,
    /lib/@{multiarch}/libsystemd.so.* mr,
    /lib/@{multiarch}/libicuuc.so.* mr,
    /lib/@{multiarch}/libgtk-*.so.* mr,
    /lib/@{multiarch}/libpango-*.so.* mr,
    /lib/@{multiarch}/libharfbuzz.so.* mr,
    /lib/@{multiarch}/libgdk_pixbuf-*.so.* mr,
    /lib/@{multiarch}/libcairo.so.* mr,
    /lib/@{multiarch}/libxml2.so.* mr,
    /lib/@{multiarch}/libsqlite3.so.* mr,
    /lib/@{multiarch}/libxslt.so.* mr,
    /lib/@{multiarch}/liblcms2.so.* mr,
    /lib/@{multiarch}/libwoff2dec.so.* mr,
    /lib/@{multiarch}/libfontconfig.so.* mr,
    /lib/@{multiarch}/libfreetype.so.* mr,
    /lib/@{multiarch}/libharfbuzz-icu.so.* mr,
    /lib/@{multiarch}/libgcrypt.so.* mr,
    /lib/@{multiarch}/libgstallocators-*.so.* mr,
    /lib/@{multiarch}/libgstapp-*.so.* mr,
    /lib/@{multiarch}/libgstbase-*.so.* mr,
    /lib/@{multiarch}/libgstreamer-*.so.* mr,
    /lib/@{multiarch}/libgstpbutils-*.so.* mr,
    /lib/@{multiarch}/libgstaudio-*.so.* mr,
    /lib/@{multiarch}/libgsttag-*.so.* mr,
    /lib/@{multiarch}/libgstvideo-*.so.* mr,
    /lib/@{multiarch}/libgstgl-*.so.* mr,
    /lib/@{multiarch}/libgstfft-*.so.* mr,
    /lib/@{multiarch}/libjpeg.so.* mr,
    /lib/@{multiarch}/libpng16.so.* mr,
    /lib/@{multiarch}/libwebpdemux.so.* mr,
    /lib/@{multiarch}/libwebp.so.* mr,
    /lib/@{multiarch}/libsoup-*.so.* mr,
    /lib/@{multiarch}/libenchant-*.so* mr,
    /lib/@{multiarch}/libsecret-*.so.* mr,
    /lib/@{multiarch}/libtasn1.so.* mr,
    /lib/@{multiarch}/libhyphen.so.* mr,
    /lib/@{multiarch}/libX11.so.* mr,
    /lib/@{multiarch}/libwayland-server.so.* mr,
    /lib/@{multiarch}/libwayland-client.so.* mr,
    /lib/@{multiarch}/libmanette-*.so.* mr,
    /lib/@{multiarch}/libseccomp.so.* mr,
    /lib/@{multiarch}/libgbm.so.* mr,
    /lib/@{multiarch}/libdrm.so.* mr,
    /lib/@{multiarch}/libstdc++.so.* mr,
    /lib/@{multiarch}/libgcc_s.so.* mr,
    /lib/@{multiarch}/libatomic.so.* mr,
    /lib/@{multiarch}/libcap.so.* mr,
    /lib/@{multiarch}/liblz4.so.* mr,
    /lib/@{multiarch}/liblzma.so.* mr,
    /lib/@{multiarch}/libzstd.so.* mr,
    /lib/@{multiarch}/libicudata.so.* mr,
    /lib/@{multiarch}/libpangocairo-1.0.so.* mr,
    /lib/@{multiarch}/libfribidi.so.* mr,
    /lib/@{multiarch}/libcairo-gobject.so.* mr,
    /lib/@{multiarch}/libgraphene-1.0.so.* mr,
    /lib/@{multiarch}/libXi.so.* mr,
    /lib/@{multiarch}/libpangoft2-1.0.so.* mr,
    /lib/@{multiarch}/libvulkan.so.* mr,
    /lib/@{multiarch}/libtiff.so.* mr,
    /lib/@{multiarch}/libxkbcommon.so.* mr,
    /lib/@{multiarch}/libwayland-egl.so.* mr,
    /lib/@{multiarch}/libXext.so.* mr,
    /lib/@{multiarch}/libXcursor.so.* mr,
    /lib/@{multiarch}/libXdamage.so.* mr,
    /lib/@{multiarch}/libXfixes.so.* mr,
    /lib/@{multiarch}/libXrandr.so.* mr,
    /lib/@{multiarch}/libXinerama.so.* mr,
    /lib/@{multiarch}/libcairo-script-interpreter.so.* mr,
    /lib/@{multiarch}/libthai.so.* mr,
    /lib/@{multiarch}/libgraphite2.so.* mr,
    /lib/@{multiarch}/libXrender.so.* mr,
    /lib/@{multiarch}/libxcb.so.* mr,
    /lib/@{multiarch}/libxcb-render.so.* mr,
    /lib/@{multiarch}/libxcb-shm.so.* mr,
    /lib/@{multiarch}/libpixman-*.so.* mr,
    /lib/@{multiarch}/libwoff2common.so.* mr,
    /lib/@{multiarch}/libbrotlidec.so.* mr,
    /lib/@{multiarch}/libexpat.so.* mr,
    /lib/@{multiarch}/libbz2.so.* mr,
    /lib/@{multiarch}/libgpg-error.so.* mr,
    /lib/@{multiarch}/libunwind.so.* mr,
    /lib/@{multiarch}/libdw-*.so mr,
    /lib/@{multiarch}/liborc-*.so.* mr,
    /lib/@{multiarch}/libGL.so.* mr,
    /lib/@{multiarch}/libEGL.so.* mr,
    /lib/@{multiarch}/libwayland-cursor.so.* mr,
    /lib/@{multiarch}/libX11-xcb.so.* mr,
    /lib/@{multiarch}/libgudev-*.so.* mr,
    /lib/@{multiarch}/libsharpyuv.so.* mr,
    /lib/@{multiarch}/libpsl.so.* mr,
    /lib/@{multiarch}/libgssapi_krb5.so.* mr,
    /lib/@{multiarch}/libnghttp2.so.* mr,
    /lib/@{multiarch}/libevdev.so.* mr,
    /lib/@{multiarch}/libxcb-randr.so.* mr,
    /lib/@{multiarch}/libLerc.so.* mr,
    /lib/@{multiarch}/libjbig.so.* mr,
    /lib/@{multiarch}/libdeflate.so.* mr,
    /lib/@{multiarch}/liblzo2.so.* mr,
    /lib/@{multiarch}/libdatrie.so.* mr,
    /lib/@{multiarch}/libXau.so.* mr,
    /lib/@{multiarch}/libXdmcp.so.* mr,
    /lib/@{multiarch}/libbrotlicommon.so.* mr,
    /lib/@{multiarch}/libelf-*.so mr,
    /lib/@{multiarch}/libGLdispatch.so.* mr,
    /lib/@{multiarch}/libGLX.so.* mr,
    /lib/@{multiarch}/libudev.so.* mr,
    /lib/@{multiarch}/libunistring.so.* mr,
    /lib/@{multiarch}/libidn2.so.* mr,
    /lib/@{multiarch}/libkrb5.so.* mr,
    /lib/@{multiarch}/libk5crypto.so.* mr,
    /lib/@{multiarch}/libcom_err.so.* mr,
    /lib/@{multiarch}/libkrb5support.so.* mr,
    /lib/@{multiarch}/libbsd.so.* mr,
    /lib/@{multiarch}/libkeyutils.so.* mr,
    /lib/@{multiarch}/libresolv.so.* mr,
    /lib/@{multiarch}/libmd.so.* mr,
    /lib/@{multiarch}/libibus-1.0.so.* mr,
    /lib/@{multiarch}/libxcb-dri2.so.* mr,
    /lib/@{multiarch}/libxcb-xfixes.so.* mr,
    /lib/@{multiarch}/libxcb-dri3.so.* mr,
    /lib/@{multiarch}/libxcb-present.so.* mr,
    /lib/@{multiarch}/libxcb-sync.so.* mr,
    /lib/@{multiarch}/libxshmfence.so.* mr,
    /lib/@{multiarch}/libLLVM-17.so.* mr,
    /lib/@{multiarch}/libsensors.so.* mr,
    /lib/@{multiarch}/libdrm_radeon.so.* mr,
    /lib/@{multiarch}/libdrm_amdgpu.so.* mr,
    /lib/@{multiarch}/libdrm_nouveau.so.* mr,
    /lib/@{multiarch}/libdrm_intel.so.* mr,
    /lib/@{multiarch}/libedit.so.* mr,
    /lib/@{multiarch}/libtinfo.so.* mr,
    /lib/@{multiarch}/libpciaccess.so.* mr,
    /lib/@{multiarch}/libGLESv2.so.* mr,    

    include if exists <local/foliate_WebKitWebProcess>
}

  profile xdg-dbus-proxy flags=(attach_disconnected.path=/container/, attach_disconnected){
    network unix,

    dbus (send) bus="accessibility" path="/" interface="org.freedesktop.DBus" member={AddMatch,GetNameOwner} peer=(label="unconfined"),
    dbus (receive) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="EventListenerDeregistered" peer=(label="unconfined"),
    dbus (send) bus="accessibility" path="/org/a11y/atspi/registry" interface="org.a11y.atspi.Registry" member="GetRegisteredEvents" peer=(label="unconfined"),
    dbus (receive) bus="accessibility" path="/org/a11y/webkit/accessible/*" interface="org.a11y.atspi.Socket" member="Embedded" peer=(label="foliate"),
    dbus (send) bus="accessibility" path="/org/freedesktop/DBus" interface="org.freedesktop.DBus" member={Hello,AddMatch,GetNameOwner,StartServiceByName,RemoveMatch} peer=(label="unconfined"),
    
    /container/dev/null r,
    /container/dev/urandom r,
    /container/proc/zoneinfo r,
    /container/proc/meminfo r,
    /container/proc/*/cgroup r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.current r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.max r,
    /container/sys/fs/cgroup/user.slice/user-@{uid}.slice/user@@{uid}.service/app.slice/app-org.gnome.Terminal.slice/vte-spawn-*.scope/memory.high r,
    /container/@{run}/user/@{uid}/.flatpak/webkit-*/bwrapinfo.json rw,
    /container/@{run}/user/@{uid}/at-spi/bus rw,

    @{etc_ro}/ld.so.cache r,
    @{etc_ro}/locale.alias r,

    /lib/@{multiarch}/ld-linux-*.so.* r,
    /lib/@{multiarch}/libglib-*.so.* mr,
    /lib/@{multiarch}/libgio-*.so.*  mr,
    /lib/@{multiarch}/libgobject-*.so.* mr,
    /lib/@{multiarch}/libc.so.* mr,
    /lib/@{multiarch}/libm.so.* mr,
    /lib/@{multiarch}/libpcre*.so.* mr,
    /lib/@{multiarch}/libgmodule-*.so.* mr,
    /lib/@{multiarch}/libz.so.* mr,
    /lib/@{multiarch}/libmount.so.* mr,
    /lib/@{multiarch}/libselinux.so.* mr,
    /lib/@{multiarch}/libffi.so.* mr,
    /lib/@{multiarch}/libblkid.so.* mr,
    @{PROC}/filesystems r,
    @{run}/user/@{uid}/webkitgtk/bus-proxy-* rw,
    @{run}/user/@{uid}/webkitgtk/** rw,
    
    /usr/lib/locale/locale-archive r,
    /usr/bin/xdg-dbus-proxy mr,
    
    include if exists <local/foliate_xdg-dbus-proxy>
  }

  profile speech-dispatcher /usr/bin/speech-dispatcher flags=(enforce) {
    include <abstractions/audio>
    include <abstractions/base>
    include <abstractions/consoles>
    include <abstractions/dbus-session-strict>

    @{etc_ro}/speech-dispatcher/** r,
    @{PROC}/sys/vm/overcommit_memory r,
    /usr/bin/speech-dispatcher mr,
    owner @{HOME}/.config/pulse/cookie rk,
    owner @{run}/user/@{uid}/ r,
    owner @{run}/user/@{uid}/pulse/ r,
    owner @{run}/user/@{uid}/pulse/native rw,
    owner @{run}/user/@{uid}/speech-dispatcher/** rwk,

    include if exists <local/foliate_speech-dispatcher>
  }

  profile WebKitNetworkProcess /usr/lib/@{multiarch}/webkitgtk-*/WebKitNetworkProcess flags=(enforce) {
    include <abstractions/base>
    include <abstractions/dbus-session>
    include <abstractions/nameservice>
    include <abstractions/ubuntu-browsers.d/ubuntu-integration>

    unix (send receive) type=seqpacket addr=none peer=(label="foliate"),
    unix (send receive) type=seqpacket addr=none peer=(label="foliate///usr/bin/bwrap"),
    unix (send receive) type=seqpacket addr=none peer=(label="foliate//WebKitWebProcess"),
    
    dbus (send receive) bus="session" path="/com/github/johnfactotum/Foliate" interface="org.gtk.Actions" member={DescribeAll,Open} peer=(label="foliate"),
    
    dbus (send) bus="system" path="/net/hadess/PowerProfiles" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
    
    dbus (receive) bus="system" path="/org/freedesktop/NetworkManager" interface="org.freedesktop.DBus.Properties" member="PropertiesChanged" peer=(label="unconfined"),
    dbus (receive) bus="system" path="/org/freedesktop/NetworkManager" interface="org.freedesktop.NetworkManager" member="StateChanged" peer=(label="unconfined"),
    dbus (send) bus="system" path="/org/freedesktop/NetworkManager" interface="org.freedesktop.DBus.Properties" member="GetAll" peer=(label="unconfined"),
    
    
    /apparmor/.null rw,
    # Access to ebooks
    @{HOME}/**.[eE][pP][uU][bB]{.wkdownload,} rw,
    @{HOME}/**.[mM][oO][bB][iI]{.wkdownload,} rw,
    @{HOME}/**.[aA][zZ][wW]{.wkdownload,} rw,
    @{HOME}/**.[kK][fF][xX]{.wkdownload,} rw,
    @{HOME}/**.[aA][zZ][wW]3{.wkdownload,} rw,
    @{HOME}/**.[fF][bB][23]{.wkdownload,} rw,
    @{HOME}/**.[cC][bB][rR]{.wkdownload,} rw,
    @{HOME}/**.[cC][bB][zZ]{.wkdownload,} rw,
    @{HOME}/**.[pP][nN][gG]{.wkdownload,} rw,
    @{HOME}/**.[jJ][pP][eE][gG]{.wkdownload,} rw,
    @{HOME}/**.[jJ][pP][gG]{.wkdownload,} rw,
    
    @{PROC}/@{pid}/cgroup r,
    @{PROC}/zoneinfo r,
    @{run}/dbus/system_bus_socket rw,
    @{sys}/devices/system/cpu/online r,
    @{sys}/fs/cgroup/**/memory.current r,
    @{sys}/fs/cgroup/**/memory.max r,
    @{sys}/fs/cgroup/**/memory.high r,
    /usr/lib/*/webkitgtk-*/WebKitNetworkProcess mr,
    
    
    owner @{PROC}/*/maps r,
    owner @{run}/user/@{uid}/bus rw,
    owner @{HOME}/.cache/com.github.johnfactotum.Foliate/** rwlk,
    owner @{HOME}/.local/share/com.github.johnfactotum.Foliate/** rw,
    owner @{HOME}/.config/dconf/user r,

    include if exists <local/foliate_WebKitNetworkProcess>
  }

  include if exists <local/foliate>
}
