# ------------------------------------------------------------------
#
#    Copyright (C) 2009-2013 Canonical Ltd.
#    Copyright (C) 2011-2020 Christian Boltz
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------
# vim: ft=apparmor

abi <abi/4.0>,

include <tunables/global>

profile dovecot /usr/{bin,sbin}/dovecot flags=(attach_disconnected) {
  include <abstractions/authentication>
  include <abstractions/base>
  include <abstractions/dovecot-common>
  include <abstractions/mysql>
  include <abstractions/nameservice>
  include <abstractions/ssl_certs>
  include <abstractions/ssl_keys>

  capability chown,
  capability dac_override,
  capability dac_read_search,
  capability fsetid,
  capability kill,
  capability net_bind_service,
  capability setuid,
  capability sys_chroot,
  capability sys_resource,

  signal send peer=/usr/lib/dovecot/*,
  signal send peer=dovecot-*,

  unix (receive, send) type=stream peer=(label=/usr/lib/dovecot/anvil),
  unix (receive, send) type=stream peer=(label=dovecot-anvil),

  # /etc/dovecot/** r,
  /usr/{bin,sbin}/dovecot rmPx,

  /usr/bin/doveconf Px,

  /usr/lib/dovecot/aggregator Px,
  /usr/lib/dovecot/anvil Px,
  /usr/lib/dovecot/auth Px,
  /usr/lib/dovecot/checkpassword-reply Px,
  /usr/lib/dovecot/config Px,
  /usr/lib/dovecot/decode2text.sh Px,
  /usr/lib/dovecot/dict Px,
  /usr/lib/dovecot/director Px,
  /usr/lib/dovecot/dns-client Px,
  /usr/lib/dovecot/doveadm-server Px,
  /usr/lib/dovecot/dovecot-lda Px,
  /usr/lib/dovecot/gdbhelper Px,
  /usr/lib/dovecot/health-check.sh Px,
  /usr/lib/dovecot/imap Px,
  /usr/lib/dovecot/imap-hibernate Px,
  /usr/lib/dovecot/imap-login Px,
  /usr/lib/dovecot/imap-urlauth Px,
  /usr/lib/dovecot/imap-urlauth-login Px,
  /usr/lib/dovecot/imap-urlauth-worker Px,
  /usr/lib/dovecot/indexer Px,
  /usr/lib/dovecot/indexer-worker Px,
  /usr/lib/dovecot/ipc Px,
  /usr/lib/dovecot/lmtp Px,
  /usr/lib/dovecot/log Px,
  /usr/lib/dovecot/maildirlock Px,
  /usr/lib/dovecot/managesieve Px,
  /usr/lib/dovecot/managesieve-login Px,
  /usr/lib/dovecot/old-stats Px,
  /usr/lib/dovecot/pop3 Px,
  /usr/lib/dovecot/pop3-login Px,
  /usr/lib/dovecot/quota-status Px,
  /usr/lib/dovecot/rawlog Px,
  /usr/lib/dovecot/replicator Px,
  /usr/lib/dovecot/script Px,
  /usr/lib/dovecot/script-login Px,
  /usr/lib/dovecot/stats Px,
  /usr/lib/dovecot/submission Px,
  /usr/lib/dovecot/submission-login Px,
  /usr/lib/dovecot/tcpwrap Px,
  /usr/lib/dovecot/xml2text Px,

  # deprecated in 2.3
  /usr/lib/dovecot/ssl-build-param Px,
  /usr/lib/dovecot/ssl-params Px,


  /usr/share/dovecot/dh.pem r,
  /usr/share/dovecot/protocols.d/   r,
  /usr/share/dovecot/protocols.d/** r,

  /var/lib/dovecot/ w,
  /var/lib/dovecot/* rwkl,

  /var/spool/postfix/private/auth w,
  /var/spool/postfix/private/dovecot-lmtp w,

  @{run}/dovecot/ rw,
  @{run}/dovecot/** rw,

  link @{run}/dovecot/** -> /var/lib/dovecot/**,

  /etc/mtab r,

  audit /etc/lsb-release r,
  audit /etc/SuSE-release r,
  audit @{PROC}/@{pid}/mounts r,

  @{PROC}/sys/fs/suid_dumpable r,

  # Site-specific additions and overrides. See local/README for details.
  include if exists <local/usr.sbin.dovecot>
  include if exists <local/dovecot>
}
